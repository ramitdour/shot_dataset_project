-- Run as SECURITYADMIN
USE ROLE SECURITYADMIN;

-- Core project roles
CREATE ROLE IF NOT EXISTS ROLE_PLATFORM_ADMIN;
CREATE ROLE IF NOT EXISTS ROLE_PIPELINE;
CREATE ROLE IF NOT EXISTS ROLE_DATA_ENGINEER;
CREATE ROLE IF NOT EXISTS ROLE_DATA_ANALYST;

-- Role hierarchy
GRANT ROLE ROLE_PIPELINE      TO ROLE ROLE_PLATFORM_ADMIN;
GRANT ROLE ROLE_DATA_ENGINEER TO ROLE ROLE_PLATFORM_ADMIN;
GRANT ROLE ROLE_DATA_ANALYST  TO ROLE ROLE_PLATFORM_ADMIN;

-- Ensure ACCOUNTADMIN can see and manage the top project role if needed
GRANT ROLE ROLE_PLATFORM_ADMIN TO ROLE ACCOUNTADMIN;

-- Technical pipeline user
-- Prefer key pair auth in production. Use MUST_CHANGE_PASSWORD only for bootstrap.
CREATE USER IF NOT EXISTS USER_PIPELINE
  DEFAULT_ROLE = ROLE_PIPELINE
  DEFAULT_WAREHOUSE = WH_INGEST
  MUST_CHANGE_PASSWORD = TRUE
  COMMENT = 'Pipeline automation user for Snowpipe and tasks';

-- Assign role to user
GRANT ROLE ROLE_PIPELINE TO USER USER_PIPELINE;
