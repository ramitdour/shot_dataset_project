-- Run as SYSADMIN
USE ROLE SYSADMIN;
USE DATABASE CLEAR_STRATEGY_DB;

-- RAW landing table with VARCHAR columns to tolerate schema drift.
-- Replace COL1, COL2, COL3 with your real headers once finalized.
CREATE OR REPLACE TABLE RAW.LANDING_TARGET (
  COL1 VARCHAR,
  COL2 VARCHAR,
  COL3 VARCHAR,
  -- extend with more VARCHAR columns as required
  SRC_FILE_NAME STRING,
  LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
) COMMENT = 'Raw landing table with safe VARCHARs and basic metadata';

-- META tables for schema logging and drift detection
CREATE TABLE IF NOT EXISTS META.SCHEMA_SNAPSHOTS (
  FILE_NAME STRING,
  HEADER ARRAY,
  HEADER_HASH STRING,
  LOADED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

CREATE TABLE IF NOT EXISTS META.SCHEMA_MISMATCH_LOG (
  FILE_NAME STRING,
  EXPECTED_HASH STRING,
  ACTUAL_HASH STRING,
  DETECTED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

-- Snowpipe with auto-ingest
-- After creation, run DESC PIPE PIPE_RAW_TO_LANDING to retrieve the SQS ARN.
-- Configure your S3 raw_csv event to send notifications to that SQS.
CREATE OR REPLACE PIPE PIPE_RAW_TO_LANDING
  AUTO_INGEST = TRUE
  AS
  COPY INTO RAW.LANDING_TARGET
  FROM (
    SELECT
      $1, $2, $3,
      METADATA$FILENAME AS SRC_FILE_NAME,
      CURRENT_TIMESTAMP()
    FROM @STG_RAW_CSV
  )
  FILE_FORMAT = (FORMAT_NAME = FF_CSV_CLEAN)
  ON_ERROR = 'CONTINUE';

-- Allow pipeline role to monitor and operate the pipe
GRANT MONITOR, OPERATE ON PIPE PIPE_RAW_TO_LANDING TO ROLE ROLE_PIPELINE;

-- Change stream on landing for incremental transforms
CREATE OR REPLACE STREAM STREAM_LANDING
  ON TABLE RAW.LANDING_TARGET
  APPEND_ONLY = TRUE;

-- Curated table with typed fields
-- Start with empty structure, then load via task
CREATE OR REPLACE TABLE CURATED.FACT_DATA AS
SELECT
  TRY_TO_NUMBER(COL1)::INT AS INDEX_COL,
  TRY_TO_NUMBER(COL2)::INT AS MATCH_EVENT_ID,
  COL3 AS GAME_SEASON,
  SRC_FILE_NAME,
  LOAD_TS
FROM RAW.LANDING_TARGET
WHERE 1 = 0;

-- Scheduled task to move from RAW to CURATED incrementally
USE WAREHOUSE WH_TRANSFORM;

CREATE OR REPLACE TASK TASK_LANDING_TO_CURATED
  WAREHOUSE = WH_TRANSFORM
  SCHEDULE = 'USING CRON 0 */1 * * * Europe/Dublin'
AS
INSERT INTO CURATED.FACT_DATA
SELECT
  TRY_TO_NUMBER(COL1)::INT,
  TRY_TO_NUMBER(COL2)::INT,
  COL3,
  SRC_FILE_NAME,
  LOAD_TS
FROM STREAM_LANDING;

-- Start the task after you validate COPY into RAW works
ALTER TASK TASK_LANDING_TO_CURATED RESUME;
