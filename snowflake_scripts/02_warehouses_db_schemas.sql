-- Run as SYSADMIN
USE ROLE SYSADMIN;

-- Resource monitor to cap monthly credits
CREATE RESOURCE MONITOR IF NOT EXISTS RM_DEFAULT
  WITH CREDIT_QUOTA = 200
  FREQUENCY = MONTHLY
  START_TIMESTAMP = IMMEDIATELY
  TRIGGERS ON 80 PERCENT DO NOTIFY
           ON 100 PERCENT DO SUSPEND;

-- Warehouses with sensible defaults
CREATE WAREHOUSE IF NOT EXISTS WH_INGEST
  WAREHOUSE_SIZE = XSMALL
  AUTO_SUSPEND = 60
  AUTO_RESUME = TRUE
  INITIALLY_SUSPENDED = TRUE
  RESOURCE_MONITOR = RM_DEFAULT
  COMMENT = 'Lightweight ingest, pipes, and small COPY operations';

CREATE WAREHOUSE IF NOT EXISTS WH_TRANSFORM
  WAREHOUSE_SIZE = SMALL
  AUTO_SUSPEND = 120
  AUTO_RESUME = TRUE
  INITIALLY_SUSPENDED = TRUE
  RESOURCE_MONITOR = RM_DEFAULT
  COMMENT = 'Transform and feature engineering workload';

CREATE WAREHOUSE IF NOT EXISTS WH_ANALYTICS
  WAREHOUSE_SIZE = XSMALL
  AUTO_SUSPEND = 60
  AUTO_RESUME = TRUE
  INITIALLY_SUSPENDED = TRUE
  RESOURCE_MONITOR = RM_DEFAULT
  COMMENT = 'BI and ad hoc analytics';

-- Database and schemas
CREATE DATABASE IF NOT EXISTS CLEAR_STRATEGY_DB COMMENT = 'Project database';
CREATE SCHEMA IF NOT EXISTS CLEAR_STRATEGY_DB.RAW;
CREATE SCHEMA IF NOT EXISTS CLEAR_STRATEGY_DB.CURATED;
CREATE SCHEMA IF NOT EXISTS CLEAR_STRATEGY_DB.ANALYTICS;
CREATE SCHEMA IF NOT EXISTS CLEAR_STRATEGY_DB.META;

-- Basic usage grants
GRANT USAGE ON DATABASE CLEAR_STRATEGY_DB TO ROLE ROLE_PIPELINE;
GRANT USAGE ON ALL SCHEMAS IN DATABASE CLEAR_STRATEGY_DB TO ROLE ROLE_PIPELINE;

GRANT USAGE ON WAREHOUSE WH_INGEST     TO ROLE ROLE_PIPELINE;
GRANT USAGE ON WAREHOUSE WH_TRANSFORM  TO ROLE ROLE_DATA_ENGINEER;
GRANT USAGE ON WAREHOUSE WH_ANALYTICS  TO ROLE ROLE_DATA_ANALYST;
