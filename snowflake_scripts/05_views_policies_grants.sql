-- Policy creation and grants
-- Use SECURITYADMIN for policies and grants
USE ROLE SECURITYADMIN;
USE DATABASE CLEAR_STRATEGY_DB;

-- Masking policy example for an email-like column
CREATE OR REPLACE MASKING POLICY MP_PII_EMAIL AS (VAL STRING) RETURNS STRING ->
  CASE
    WHEN CURRENT_ROLE() IN ('ROLE_PLATFORM_ADMIN', 'ROLE_DATA_ENGINEER') THEN VAL
    WHEN VAL IS NULL THEN NULL
    ELSE REGEXP_REPLACE(VAL, '(^.).*(@.*$)', '\\1***\\2')
  END;

-- Optional tag to mark PII or data class
CREATE OR REPLACE TAG TAG_CLASSIFICATION ALLOWED_VALUES 'PII','CONFIDENTIAL','PUBLIC';

-- Optional network policy stub to limit console access by IPs
-- Replace the CIDR values with your allow list before enabling
-- CREATE OR REPLACE NETWORK POLICY NETWORK_POLICY
--   ALLOWED_IP_LIST = ('203.0.113.0/24', '198.51.100.10/32')
--   BLOCKED_IP_LIST = ();

-- Analytics view with safe projection for BI
USE ROLE SYSADMIN;  -- Create objects as SYSADMIN by convention
CREATE OR REPLACE VIEW ANALYTICS.VW_FACT_DATA AS
SELECT
  INDEX_COL,
  MATCH_EVENT_ID,
  GAME_SEASON
FROM CURATED.FACT_DATA;

-- Final grants
USE ROLE SECURITYADMIN;

-- Database and schema usage for engineers and analysts
GRANT USAGE ON DATABASE CLEAR_STRATEGY_DB TO ROLE ROLE_DATA_ENGINEER, ROLE ROLE_DATA_ANALYST;
GRANT USAGE ON SCHEMA CURATED   TO ROLE ROLE_DATA_ENGINEER, ROLE ROLE_DATA_ANALYST;
GRANT USAGE ON SCHEMA ANALYTICS TO ROLE ROLE_DATA_ANALYST;

-- Object-level privileges
GRANT SELECT ON ALL TABLES IN SCHEMA CURATED TO ROLE ROLE_DATA_ENGINEER;
GRANT SELECT ON VIEW ANALYTICS.VW_FACT_DATA TO ROLE ROLE_DATA_ANALYST;

-- Pipeline operational permissions
GRANT MONITOR, OPERATE ON PIPE PIPE_RAW_TO_LANDING TO ROLE ROLE_PIPELINE;

-- Warehouse usage for BI
GRANT USAGE ON WAREHOUSE WH_ANALYTICS TO ROLE ROLE_DATA_ANALYST;

-- Ownership transfers
-- Must be executed by the current owner role, usually SYSADMIN
-- Switch to SYSADMIN for ownership changes, then back to SECURITYADMIN
USE ROLE SYSADMIN;

-- Give engineers ownership of curated table and the transform task
GRANT OWNERSHIP ON TABLE CURATED.FACT_DATA TO ROLE ROLE_DATA_ENGINEER REVOKE CURRENT GRANTS;
GRANT OWNERSHIP ON TASK  TASK_LANDING_TO_CURATED TO ROLE ROLE_DATA_ENGINEER REVOKE CURRENT GRANTS;

-- Optional: apply masking policy and tag on specific columns once they exist
-- ALTER TABLE CURATED.FACT_DATA
--   MODIFY COLUMN USER_EMAIL SET MASKING POLICY MP_PII_EMAIL;
-- ALTER TABLE CURATED.FACT_DATA
--   MODIFY COLUMN USER_EMAIL SET TAG TAG_CLASSIFICATION = 'PII';
